{% extends 'core/base.html' %}
{% load static %}
{% block link %}
    <link rel="stylesheet" href="{% static 'core/css/c.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/styles_carrito.css' %}">
{% endblock %}

{% block cont %}
<section class="page-section bg-light" id="productos">
    <div class="container1 px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5">
            <div class="container1">
                <h2>Carrito de Compras</h2>
                <hr class="divider" />
                
                <div class="section products product-container1">
                    <h3>Tu Carrito</h3>
                    <!-- Los productos se añadirán dinámicamente aquí -->
                </div>

                <div class="total-section">
                    Total a Pagar: CLP $<span id="total">0</span>
                    <button class="buy-btn" id="buy-btn" onclick="handleBuy()">Comprar</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Leer los parámetros de la URL
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get('productId');
const productName = urlParams.get('productName');
const productPrice = urlParams.get('productPrice');

// Estructura del carrito (en el navegador)
let cart = JSON.parse(localStorage.getItem('cart')) || {};

// Si hay datos del producto en la URL, añadirlo al carrito
if (productId && productName && productPrice) {
  addToCart(productId, productName, parseFloat(productPrice));
}

// Función para añadir productos al carrito
function addToCart(productId, productName, productPrice) {
  // Si el producto ya existe en el carrito, aumentamos la cantidad
  if (cart[productId]) {
    cart[productId].quantity++;
  } else {
    // Si no existe, lo añadimos con cantidad 1
    cart[productId] = { name: productName, price: productPrice, quantity: 1 };
  }

  // Actualizar el carrito en el almacenamiento local
  localStorage.setItem('cart', JSON.stringify(cart));
  
  renderCart();
}

// Función para cambiar la cantidad de un producto
function changeProductQuantity(productId, change) {
  const product = cart[productId];
  if (product) {
    product.quantity += change;
    if (product.quantity < 1) product.quantity = 1;  // No permitir cantidad negativa
    renderCart();  // Volver a renderizar el carrito
  }
}

// Función para eliminar un producto del carrito
function removeProduct(productId) {
  delete cart[productId];  // Eliminar del carrito
  localStorage.setItem('cart', JSON.stringify(cart));  // Actualizar almacenamiento local
  renderCart();  // Volver a renderizar el carrito
}

// Función para actualizar el total del carrito
function updateTotal() {
  let total = 0;
  for (let productId in cart) {
    const product = cart[productId];
    total += product.quantity * product.price;
  }
  document.getElementById('total').textContent = total.toFixed(2);  // Mostrar con dos decimales
}

// Función para renderizar el carrito en el DOM
function renderCart() {
  const cartContainer = document.querySelector('.product-container1');
  cartContainer.innerHTML = '';  // Limpiar el contenedor antes de renderizar

  // Agregar productos al carrito
  for (let productId in cart) {
    const product = cart[productId];
    const productElement = document.createElement('div');
    productElement.className = 'product';
    productElement.id = `product-${productId}`;

    // Crear el contenido HTML para el producto
    productElement.innerHTML = `
      <span class="product-name">${product.name}</span>
      <span class="product-price">CLP $${product.price}</span>
      <div class="quantity-control">
        <button onclick="changeProductQuantity('${productId}', -1)">-</button>
        <span id="product-${productId}-quantity">${product.quantity}</span>
        <button onclick="changeProductQuantity('${productId}', 1)">+</button>
        <button class="remove-btn" onclick="removeProduct('${productId}')">Eliminar</button>
      </div>
    `;

    // Agregar el producto al contenedor del carrito
    cartContainer.appendChild(productElement);
  }

  // Actualizar el total
  updateTotal();
}

// Función para realizar la compra (puedes personalizar según el backend)
function handleBuy() {
  if (Object.keys(cart).length === 0) {
    alert('No hay productos en el carrito para comprar.');
  } else {
    alert('Compra realizada exitosamente.');
    // Limpiar el carrito después de realizar la compra
    localStorage.removeItem('cart');
    renderCart();  // Volver a renderizar el carrito vacío
  }
}

// Iniciar renderizado del carrito al cargar la página
renderCart();
</script>

{% endblock %}
